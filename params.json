{
  "name": "Linear.tools GitHub",
  "tagline": "See CRAN for the official version",
  "body": "# <center> <h1> linear.tools </h1> </center> <center> <h1>  </h1> </center>\r\n</center> <font size=\"4\">Fan Yang</font> </center>  \r\n2015-08-10 <center> <h1>  </h1> </center>  \r\n\r\n<center> <h1>  </h1> </center> \r\n\r\nThis package has two parts: \r\n\r\n  * The first part provides tools to manipulate formulas.\r\n  * The second part provides functions to evaluate and check the marginal impacts of a linear model.\r\n\r\n\r\n\r\n\r\n# First Part: Manipulate formulas\r\n### different forms of x\r\n\r\nVariables in R's linear formula/model can have different forms:\r\n\r\n  1.  Model variables, the items showed up directly in the formula, separated by the '+' sign.\r\n  2.  Raw variables, the underlying variables used.\r\n  3.  Coefficient variables, the coefficient names; note that un-evaluated formulas don't have those variables.\r\n\r\n### model variables: `get_x(formula/model,'coeff')`\r\n\r\n```r\r\ndata = ggplot2::diamonds\r\ndiamond_lm  =  lm(log(price)~  I(carat^   2) + cut  + carat + table + carat:table, data)\r\n```\r\n\r\nAt the first sight, the linear model above contains 5  variables:\r\n\r\n* I(carat^   2)\r\n* cut\r\n* carat\r\n* table\r\n* carat:table\r\n\r\nIn linear.tools we call them *model* variables and can access them using function `get_x(.,'model')`:\r\n\r\n\r\n```r\r\nget_x(diamond_lm,'model')\r\n```\r\n\r\n```\r\n## [1] \"I(carat^2)\"  \"cut\"         \"carat\"       \"table\"       \"carat:table\"\r\n```\r\n\r\n\r\nNote that in the original formula, there are redundant spaces 'I(carat^   2)'; in `get_x(.,'model')` we deleted them.\r\n\r\n### raw variables: `get_x(formula/model,'coeff')`\r\n\r\nSometimes you want to get the underlying raw variables used in the formula, which are\r\n\r\n* carat (the underlying variable for I(carat^   2))\r\n* cut\r\n* carat\r\n* table\r\n\r\nIn linear.tools we call them *raw* variables and can access them using function `get_x(.,'raw')`:\r\n\r\n\r\n```r\r\nget_x(diamond_lm,'raw')\r\n```\r\n\r\n```\r\n## [1] \"carat\" \"cut\"   \"table\"\r\n```\r\n\r\n`get_x(.,'model')` will show the linkage between model variables and raw variables: it will return a list with names as model variables and elements as their corresponding raw variables.\r\n\r\n```r\r\nget_model_pair(diamond_lm, data, 'raw')\r\n```\r\n\r\n```\r\n## $`I(carat^2)`\r\n## [1] \"carat\"\r\n## \r\n## $cut\r\n## [1] \"cut\"\r\n## \r\n## $carat\r\n## [1] \"carat\"\r\n## \r\n## $table\r\n## [1] \"table\"\r\n## \r\n## $`carat:table`\r\n## [1] \"carat\" \"table\"\r\n```\r\n\r\n\r\n### coefficient variables: `get_x(model,'coeff')`\r\n\r\nSometimes you want the the coefficient names of the model\r\n\r\n\r\n```r\r\nget_x(diamond_lm,'coeff')\r\n```\r\n\r\n```\r\n## [1] \"I(carat^2)\"  \"cut.L\"       \"cut.Q\"       \"cut.C\"       \"cut^4\"      \r\n## [6] \"carat\"       \"table\"       \"carat:table\"\r\n```\r\n\r\n\r\nYou may also want to see how 'model' variables are linked with 'coeff' variables: `get_x(.,'coeff')` will return a list with names as model variables and elements as their corresponding coeff variables.\r\n\r\n\r\n```r\r\nget_model_pair(diamond_lm, data, 'coeff')\r\n```\r\n\r\n```\r\n## $`I(carat^2)`\r\n## [1] \"I(carat^2)\"\r\n## \r\n## $cut\r\n## [1] \"cut.L\" \"cut.Q\" \"cut.C\" \"cut^4\"\r\n## \r\n## $carat\r\n## [1] \"carat\"\r\n## \r\n## $table\r\n## [1] \"table\"\r\n## \r\n## $`carat:table`\r\n## [1] \"carat:table\"\r\n```\r\n\r\n\r\n\r\n\r\n\r\n### link different forms of x: `get_x_all(model)`\r\n\r\nThe `get_x_all()` function will return a data.frame showing all the model variables and their corresponding raw & coefficient variables.\r\n\r\n\r\n```r\r\nget_x_all(model = diamond_lm)\r\n```\r\n\r\n```\r\n##     raw       model       coeff n_raw_in_model\r\n## 1 carat  I(carat^2)  I(carat^2)              1\r\n## 2   cut         cut       cut.L              1\r\n## 3   cut         cut       cut.Q              1\r\n## 4   cut         cut       cut.C              1\r\n## 5   cut         cut       cut^4              1\r\n## 6 carat       carat       carat              1\r\n## 7 table       table       table              1\r\n## 8 carat carat:table carat:table              2\r\n## 9 table carat:table carat:table              2\r\n```\r\n\r\n\r\n### get y : `get_y(formula/model)`\r\n\r\n\r\n```r\r\nget_y(diamond_lm,'raw')\r\n```\r\n\r\n```\r\n## [1] \"price\"\r\n```\r\n\r\n```r\r\nget_y(diamond_lm,'model')\r\n```\r\n\r\n```\r\n## [1] \"log(price)\"\r\n```\r\n\r\n\r\n## contrast: get_contrast(model)\r\n\r\nContrasts are how categorical variables show up in coefficients.\r\n\r\nWhen R evaluate categorical variables in the linear model, R will transform them into sets of 'contrasts' using certain contrast encoding schedule. See [UCLA idre](http://www.ats.ucla.edu/stat/r/library/contrast_coding.htm) for details.\r\n\r\nFor example, for categorical variable 'cut' in the above model, we can get its contrasts through function `get_contrast`\r\n\r\n\r\n```r\r\n# get_contrast will return a list with each element as the contrasts of a categorical variable in the model\r\nget_contrast(diamond_lm)\r\n```\r\n\r\n```\r\n## $cut\r\n## [1] \"cut.L\" \"cut.Q\" \"cut.C\" \"cut^4\"\r\n```\r\n\r\nYou can also return the contrast method.\r\n\r\n```r\r\nget_contrast(diamond_lm, return_method = T)\r\n```\r\n\r\n```\r\n## $cut\r\n## contr.poly\r\n```\r\n\r\n\r\n# Second Part: Evaluate Marginal Effect\r\n\r\nIn formula `y ~ a + I(a^2) + b`, We define 'Marginal Effect' of `a` on `y` as: fixing `b`, how the change of `a` will affect value of `y`. Note that the marginal effect here is not just the coefficients for `a` and `I(a^2)`, neither the sum.\r\n\r\n### evaluate marginal effect: `effect`\r\nWe provide a easy tool to show the marginal effect and check its monotonicity. The example below will evaluate how the `carat` of the diamond will affect its `price` in a particular model.\r\n\r\n\r\n\r\n```r\r\n# more carats, higher price.\r\ndiamond_lm3 = lm(price~  carat + I(carat^2) + I(carat^3) , ggplot2::diamonds) # a GLM\r\n\r\ntest1 = effect(model = diamond_lm3, focus_var_raw = c('carat'), focus_value =list(carat = seq(0.5,1,0.1))) \r\n```\r\n\r\n![](https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-12-1.png)\r\n\r\n```r\r\ntest1$Monoton_Increase\r\n```\r\n\r\n```\r\n## [1] TRUE\r\n```\r\nYou can see that the model did a good job to model monotonic increasing relations between `carat` and `price` when `carat` ranges from 0.5 to 1 (`$Monoton_Increase` is `True`).\r\n\r\nPS: A more interesting case is that, if you interact `carat` with the categorical variable `cut`, you can examine the marginal effects `carat` under different categories of `cut`\r\n\r\n```r\r\ntest_interaction = effect(model = lm(price~  carat*cut + I(carat^2)*cut, ggplot2::diamonds), \r\n       focus_var_raw = c('carat','cut'), focus_value =list(carat = seq(0.5,1,0.1))\r\n       ) \r\n```\r\n\r\n![](https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-13-1.png)\r\n\r\n\r\nHowever, in the model `diamond_lm3` when we let the `carat` ranges from 0.5 to 6, the model failed to get the monotonic increasing relations: in the model below, when carat is larger than 3 approximately, the higher the carat, the lower the price!\r\n  \r\n\r\n```r\r\ntest2 = effect(model = diamond_lm3, focus_var_raw = c('carat'), focus_value =list(carat = seq(0.5,6,0.1))) \r\n```\r\n\r\n![](https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-14-1.png)\r\n\r\n```r\r\ntest2$Monoton_Increase\r\n```\r\n\r\n```\r\n## [1] FALSE\r\n```\r\n\r\n\r\n### delete the marginal effect and re-evaluate\r\n\r\nWhen a model has a wrong marginal effect, we can use function `deleting_wrongeffect` to delete a model variable that potentially causes the wrong marginal impacts and then re-estimate the model. This function can keep doing this until the correct marginal impacts are found.\r\n\r\nThe example below will\r\n\r\n  * first test the marginal effect of carat on price, which is supposed to be monotonic increasing.\r\n  * then as it finds incorrect marginal effect, it will delete one model variable that contains `carat` in the most right, and then recheck the marginal effect.\r\n  * It will keep doing the same thing until the marginal effect is correct, or all model variables containing `carat` are deleted.\r\n\r\n\r\n```r\r\nmodel_correct_effect = deleting_wrongeffect(model = diamond_lm3,\r\n                                            focus_var_raw = 'carat',\r\n                                            focus_value = list(carat=seq(0.5,6,0.1)),\r\n                                            data = ggplot2::diamonds,\r\n                                            PRINT = T,STOP =F, PLOT = T,\r\n                                            Reverse = F)\r\n```\r\n\r\n```\r\n## \r\n## initial model: \r\n##               Estimate     Pr(>|t|)\r\n## (Intercept)  -198.3337 3.930283e-11\r\n## carat         812.3639 1.540245e-19\r\n## I(carat^2)   5813.2637 0.000000e+00\r\n## I(carat^3)  -1308.8438 0.000000e+00\r\n## \r\n## \r\n## check raw var:  carat \r\n## check model var:  carat, I(carat^2), I(carat^3) \r\n## Correct Monotonicity is supposed to be:  Increasing\r\n```\r\n\r\n![](https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-15-1.png)\r\n\r\n```\r\n## Monotonicity is incorrect \r\n## Variable  I(carat^3)  shall be deleted, and the model shall be re-estimated. \r\n## -------------------------------------------------------\r\n## \r\n## New Model: \r\n##               Estimate      Pr(>|t|)\r\n## (Intercept) -1832.5774  0.000000e+00\r\n## carat        6677.0273  0.000000e+00\r\n## I(carat^2)    507.9133 9.695712e-131\r\n## \r\n## \r\n## check raw var:  carat \r\n## check model var:  carat, I(carat^2) \r\n## Correct Monotonicity is supposed to be:  Increasing\r\n```\r\n\r\n![](https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-15-2.png)\r\n\r\n```\r\n## Monotonicity is correct\r\n```\r\n\r\n```r\r\nmodel_correct_effect\r\n```\r\n\r\n```\r\n## \r\n## Call:  glm(formula = Formula_new, family = family, data = data0)\r\n## \r\n## Coefficients:\r\n## (Intercept)        carat   I(carat^2)  \r\n##     -1832.6       6677.0        507.9  \r\n## \r\n## Degrees of Freedom: 53939 Total (i.e. Null);  53937 Residual\r\n## Null Deviance:\t    8.585e+11 \r\n## Residual Deviance: 1.279e+11 \tAIC: 944900\r\n```\r\n\r\n### stepwise regression with correct marginal effect\r\n\r\nStepwise regression is popular in variable selection, but it failed to consider the correctness of marginal effects. `stepwise2` enables checking the marginal effects during each step of iteration in stepwise regression; so in each step we will skip those models with wrong marginal effects, and only only choose models among those that have correct marginal effect.\r\n\r\nThe example below is to use stepwise regression to find the model with highest BIC and with the correct marginal effect.\r\n\r\n\r\n```r\r\nscope = list(lower = price ~ 1,\r\n             upper = price ~  carat + I(carat^2) + I(carat^3) + I(carat * depth) + depth)\r\n\r\n\r\n### specify the correct marginal effect here\r\ntest_suit = list(\r\n  carat = list( # the list name must be the raw var\r\n    focus_var_raw = \"carat\", # must specify the focus_var_raw (see deleting_wrongeffect() ) as the raw var\r\n    focus_value = list(carat=seq(0.5,6,0.1))\r\n  )\r\n)\r\n\r\nmodel_correct_effect =  stepwise2(model = diamond_lm3, scope = scope, trace = T,\r\n                                  data = ggplot2::diamonds, STOP = F, test_suit = test_suit)\r\n```\r\n\r\n```\r\n## \r\n##  price ~ carat+I(carat^2)+I(carat^3) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat^3) + I(carat*depth) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat^3) + depth \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat^3) - carat \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat^3) - I(carat^2) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat^3) - I(carat^3) \r\n## ------------------------\r\n##                        IC nvar step_count correct_effect_ind\r\n## + I(carat*depth) 938807.6    4          1                  0\r\n## + depth          939091.3    4          1                  0\r\n## origin           939528.7    3          1                  0\r\n## - carat          939608.4    2          1                  0\r\n## - I(carat^3)     944876.6    2          1                  1\r\n## - I(carat^2)     945450.7    2          1                  1\r\n## \r\n## \r\n## \r\n##  price ~ carat+I(carat^2) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2) + I(carat^3) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2) + I(carat*depth) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2) + depth \r\n## ------------------------\r\n##  price ~ carat+I(carat^2) - carat \r\n## ------------------------\r\n##  price ~ carat+I(carat^2) - I(carat^2) \r\n## ------------------------\r\n##                        IC nvar step_count correct_effect_ind\r\n## + I(carat^3)     939528.7    3          2                  0\r\n## + I(carat*depth) 943888.0    3          2                  1\r\n## + depth          944394.5    3          2                  1\r\n## origin           944876.6    2          2                  1\r\n## - I(carat^2)     945466.5    1          2                  1\r\n## - carat          962398.3    1          2                  1\r\n## \r\n## \r\n## \r\n##  price ~ carat+I(carat^2)+I(carat*depth) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat*depth) + I(carat^3) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat*depth) + depth \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat*depth) - carat \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat*depth) - I(carat^2) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat*depth) - I(carat*depth) \r\n## ------------------------\r\n##                        IC nvar step_count correct_effect_ind\r\n## + I(carat^3)     938807.6    4          3                  0\r\n## + depth          943753.7    4          3                  1\r\n## origin           943888.0    3          3                  1\r\n## - I(carat^2)     944552.6    2          3                  1\r\n## - I(carat*depth) 944876.6    2          3                  1\r\n## - carat          946883.6    2          3                  1\r\n## \r\n## \r\n## \r\n##  price ~ carat+I(carat^2)+I(carat*depth)+depth \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat*depth)+depth + I(carat^3) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat*depth)+depth - carat \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat*depth)+depth - I(carat^2) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat*depth)+depth - I(carat*depth) \r\n## ------------------------\r\n##  price ~ carat+I(carat^2)+I(carat*depth)+depth - depth \r\n## ------------------------\r\n##                        IC nvar step_count correct_effect_ind\r\n## + I(carat^3)     938779.0    5          4                  0\r\n## origin           943753.7    4          4                  1\r\n## - depth          943888.0    3          4                  1\r\n## - I(carat*depth) 944394.5    3          4                  1\r\n## - I(carat^2)     944466.4    3          4                  1\r\n## - carat          945118.7    3          4                  1\r\n```\r\n\r\n```r\r\n# the returned model\r\nmodel_correct_effect\r\n```\r\n\r\n```\r\n## \r\n## Call:  glm(formula = price ~ carat + I(carat^2) + I(carat * depth) + \r\n##     depth, family = family, data = data)\r\n## \r\n## Coefficients:\r\n##      (Intercept)             carat        I(carat^2)  I(carat * depth)  \r\n##          -8695.2           20984.0             555.1            -233.1  \r\n##            depth  \r\n##            111.7  \r\n## \r\n## Degrees of Freedom: 53939 Total (i.e. Null);  53935 Residual\r\n## Null Deviance:\t    8.585e+11 \r\n## Residual Deviance: 1.253e+11 \tAIC: 943800\r\n```\r\n\r\n### compare with `step`\r\nThe model using `stepwise2` got correct marginal effect:\r\n\r\n\r\n```r\r\ntest_model_correct_effect = effect(model = model_correct_effect, focus_var_raw = c('carat'), focus_value =list(carat = seq(0.5,6,0.1))) \r\n```\r\n\r\n![](https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-17-1.png)\r\n\r\nwhereas the model using traditional algorithm `step` got wrong marginal effect:\r\n  \r\n\r\n```r\r\nmodel_wrong_effect =  step(diamond_lm3, scope = scope, trace = F, data = ggplot2::diamonds)\r\nmodel_wrong_effect\r\n```\r\n\r\n```\r\n## \r\n## Call:\r\n## lm(formula = price ~ carat + I(carat^2) + I(carat^3) + I(carat * \r\n##     depth) + depth, data = ggplot2::diamonds)\r\n## \r\n## Coefficients:\r\n##      (Intercept)             carat        I(carat^2)        I(carat^3)  \r\n##         -3373.61          10638.46           5650.71          -1261.05  \r\n## I(carat * depth)             depth  \r\n##          -156.54             50.77\r\n```\r\n\r\n```r\r\ntest_wrong_effect = effect(model_wrong_effect, focus_var_raw = c('carat'), focus_value =list(carat = seq(0.5,6,0.1))) \r\n```\r\n\r\n![](https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-18-1.png)\r\n\r\n\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}