<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title></title>

<script src="linear.tools_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="linear.tools_files/bootstrap-3.3.5/css/united.min.css" rel="stylesheet" />
<script src="linear.tools_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="linear.tools_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="linear.tools_files/bootstrap-3.3.5/shim/respond.min.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code > span.dt { color: #204a87; } /* DataType */
code > span.dv { color: #0000cf; } /* DecVal */
code > span.bn { color: #0000cf; } /* BaseN */
code > span.fl { color: #0000cf; } /* Float */
code > span.ch { color: #4e9a06; } /* Char */
code > span.st { color: #4e9a06; } /* String */
code > span.co { color: #8f5902; font-style: italic; } /* Comment */
code > span.ot { color: #8f5902; } /* Other */
code > span.al { color: #ef2929; } /* Alert */
code > span.fu { color: #000000; } /* Function */
code > span.er { color: #a40000; font-weight: bold; } /* Error */
code > span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #000000; } /* SpecialChar */
code > span.vs { color: #4e9a06; } /* VerbatimString */
code > span.ss { color: #4e9a06; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #000000; } /* Variable */
code > span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code > span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code > span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code > span.ex { } /* Extension */
code > span.at { color: #c4a000; } /* Attribute */
code > span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code > span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<div class="container-fluid main-container">

<!-- tabsets -->
<script src="linear.tools_files/navigation-1.0/tabsets.js"></script>
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="fluid-row" id="header">



<h1 class="title toc-ignore"><center>
<h1>
linear.tools
</h1>
</center>
<center>
<h1>
</h1>
</center></h1>
<h4 class="author"><em></center>
<font size="4">Fan Yang</font>
</center></em></h4>
<h4 class="date"><em>2015-08-10
<center>
<h1>
</h1>
</center></em></h4>

</div>

<div id="TOC">
<ul>
<li><a href="#first-part-manipulate-formulas"><span class="toc-section-number">1</span> First Part: Manipulate formulas</a><ul>
<li><a href="#different-forms-of-x"><span class="toc-section-number">1.0.1</span> different forms of x</a></li>
<li><a href="#model-variables-get_xformulamodelcoeff"><span class="toc-section-number">1.0.2</span> model variables: <code>get_x(formula/model,'coeff')</code></a></li>
<li><a href="#raw-variables-get_xformulamodelcoeff"><span class="toc-section-number">1.0.3</span> raw variables: <code>get_x(formula/model,'coeff')</code></a></li>
<li><a href="#coefficient-variables-get_xmodelcoeff"><span class="toc-section-number">1.0.4</span> coefficient variables: <code>get_x(model,'coeff')</code></a></li>
<li><a href="#link-different-forms-of-x-get_x_allmodel"><span class="toc-section-number">1.0.5</span> link different forms of x: <code>get_x_all(model)</code></a></li>
<li><a href="#get-y-get_yformulamodel"><span class="toc-section-number">1.0.6</span> get y : <code>get_y(formula/model)</code></a></li>
<li><a href="#contrast-get_contrastmodel"><span class="toc-section-number">1.1</span> contrast: get_contrast(model)</a></li>
</ul></li>
<li><a href="#second-part-evaluate-marginal-effect"><span class="toc-section-number">2</span> Second Part: Evaluate Marginal Effect</a><ul>
<li><a href="#evaluate-marginal-effect-effect"><span class="toc-section-number">2.0.1</span> evaluate marginal effect: <code>effect</code></a></li>
<li><a href="#delete-the-marginal-effect-and-re-evaluate"><span class="toc-section-number">2.0.2</span> delete the marginal effect and re-evaluate</a></li>
<li><a href="#stepwise-regression-with-correct-marginal-effect"><span class="toc-section-number">2.0.3</span> stepwise regression with correct marginal effect</a></li>
<li><a href="#compare-with-step"><span class="toc-section-number">2.0.4</span> compare with <code>step</code></a></li>
</ul></li>
</ul>
</div>

<center>
<h1>
</h1>
</center>
<p>This package has two parts:</p>
<ul>
<li>The first part provides tools to manipulate formulas.</li>
<li>The second part provides functions to evaluate and check the marginal impacts of a linear model.</li>
</ul>
<div id="first-part-manipulate-formulas" class="section level1">
<h1><span class="header-section-number">1</span> First Part: Manipulate formulas</h1>
<div id="different-forms-of-x" class="section level3">
<h3><span class="header-section-number">1.0.1</span> different forms of x</h3>
<p>Variables in R’s linear formula/model can have different forms:</p>
<ol style="list-style-type: decimal">
<li>Model variables, the items showed up directly in the formula, separated by the ‘+’ sign.</li>
<li>Raw variables, the underlying variables used.</li>
<li>Coefficient variables, the coefficient names; note that un-evaluated formulas don’t have those variables.</li>
</ol>
</div>
<div id="model-variables-get_xformulamodelcoeff" class="section level3">
<h3><span class="header-section-number">1.0.2</span> model variables: <code>get_x(formula/model,'coeff')</code></h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data =<span class="st"> </span>ggplot2::diamonds
diamond_lm  =<span class="st">  </span><span class="kw">lm</span>(<span class="kw">log</span>(price)~<span class="st">  </span><span class="kw">I</span>(carat^<span class="st">   </span><span class="dv">2</span>) +<span class="st"> </span>cut  +<span class="st"> </span>carat +<span class="st"> </span>table +<span class="st"> </span>carat:table, data)</code></pre></div>
<p>At the first sight, the linear model above contains 5 variables:</p>
<ul>
<li>I(carat^ 2)</li>
<li>cut</li>
<li>carat</li>
<li>table</li>
<li>carat:table</li>
</ul>
<p>In linear.tools we call them <em>model</em> variables and can access them using function <code>get_x(.,'model')</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">get_x</span>(diamond_lm,<span class="st">&#39;model&#39;</span>)</code></pre></div>
<pre><code>## [1] &quot;I(carat^2)&quot;  &quot;cut&quot;         &quot;carat&quot;       &quot;table&quot;       &quot;carat:table&quot;</code></pre>
<p>Note that in the original formula, there are redundant spaces ‘I(carat^ 2)’; in <code>get_x(.,'model')</code> we deleted them.</p>
</div>
<div id="raw-variables-get_xformulamodelcoeff" class="section level3">
<h3><span class="header-section-number">1.0.3</span> raw variables: <code>get_x(formula/model,'coeff')</code></h3>
<p>Sometimes you want to get the underlying raw variables used in the formula, which are</p>
<ul>
<li>carat (the underlying variable for I(carat^ 2))</li>
<li>cut</li>
<li>carat</li>
<li>table</li>
</ul>
<p>In linear.tools we call them <em>raw</em> variables and can access them using function <code>get_x(.,'raw')</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">get_x</span>(diamond_lm,<span class="st">&#39;raw&#39;</span>)</code></pre></div>
<pre><code>## [1] &quot;carat&quot; &quot;cut&quot;   &quot;table&quot;</code></pre>
<p><code>get_x(.,'model')</code> will show the linkage between model variables and raw variables: it will return a list with names as model variables and elements as their corresponding raw variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">get_model_pair</span>(diamond_lm, data, <span class="st">&#39;raw&#39;</span>)</code></pre></div>
<pre><code>## $`I(carat^2)`
## [1] &quot;carat&quot;
## 
## $cut
## [1] &quot;cut&quot;
## 
## $carat
## [1] &quot;carat&quot;
## 
## $table
## [1] &quot;table&quot;
## 
## $`carat:table`
## [1] &quot;carat&quot; &quot;table&quot;</code></pre>
</div>
<div id="coefficient-variables-get_xmodelcoeff" class="section level3">
<h3><span class="header-section-number">1.0.4</span> coefficient variables: <code>get_x(model,'coeff')</code></h3>
<p>Sometimes you want the the coefficient names of the model</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">get_x</span>(diamond_lm,<span class="st">&#39;coeff&#39;</span>)</code></pre></div>
<pre><code>## [1] &quot;I(carat^2)&quot;  &quot;cut.L&quot;       &quot;cut.Q&quot;       &quot;cut.C&quot;       &quot;cut^4&quot;      
## [6] &quot;carat&quot;       &quot;table&quot;       &quot;carat:table&quot;</code></pre>
<p>You may also want to see how ‘model’ variables are linked with ‘coeff’ variables: <code>get_x(.,'coeff')</code> will return a list with names as model variables and elements as their corresponding coeff variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">get_model_pair</span>(diamond_lm, data, <span class="st">&#39;coeff&#39;</span>)</code></pre></div>
<pre><code>## $`I(carat^2)`
## [1] &quot;I(carat^2)&quot;
## 
## $cut
## [1] &quot;cut.L&quot; &quot;cut.Q&quot; &quot;cut.C&quot; &quot;cut^4&quot;
## 
## $carat
## [1] &quot;carat&quot;
## 
## $table
## [1] &quot;table&quot;
## 
## $`carat:table`
## [1] &quot;carat:table&quot;</code></pre>
</div>
<div id="link-different-forms-of-x-get_x_allmodel" class="section level3">
<h3><span class="header-section-number">1.0.5</span> link different forms of x: <code>get_x_all(model)</code></h3>
<p>The <code>get_x_all()</code> function will return a data.frame showing all the model variables and their corresponding raw &amp; coefficient variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">get_x_all</span>(<span class="dt">model =</span> diamond_lm)</code></pre></div>
<pre><code>##     raw       model       coeff n_raw_in_model
## 1 carat  I(carat^2)  I(carat^2)              1
## 2   cut         cut       cut.L              1
## 3   cut         cut       cut.Q              1
## 4   cut         cut       cut.C              1
## 5   cut         cut       cut^4              1
## 6 carat       carat       carat              1
## 7 table       table       table              1
## 8 carat carat:table carat:table              2
## 9 table carat:table carat:table              2</code></pre>
</div>
<div id="get-y-get_yformulamodel" class="section level3">
<h3><span class="header-section-number">1.0.6</span> get y : <code>get_y(formula/model)</code></h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">get_y</span>(diamond_lm,<span class="st">&#39;raw&#39;</span>)</code></pre></div>
<pre><code>## [1] &quot;price&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">get_y</span>(diamond_lm,<span class="st">&#39;model&#39;</span>)</code></pre></div>
<pre><code>## [1] &quot;log(price)&quot;</code></pre>
</div>
<div id="contrast-get_contrastmodel" class="section level2">
<h2><span class="header-section-number">1.1</span> contrast: get_contrast(model)</h2>
<p>Contrasts are how categorical variables show up in coefficients.</p>
<p>When R evaluate categorical variables in the linear model, R will transform them into sets of ‘contrasts’ using certain contrast encoding schedule. See <a href="http://www.ats.ucla.edu/stat/r/library/contrast_coding.htm">UCLA idre</a> for details.</p>
<p>For example, for categorical variable ‘cut’ in the above model, we can get its contrasts through function <code>get_contrast</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get_contrast will return a list with each element as the contrasts of a categorical variable in the model</span>
<span class="kw">get_contrast</span>(diamond_lm)</code></pre></div>
<pre><code>## $cut
## [1] &quot;cut.L&quot; &quot;cut.Q&quot; &quot;cut.C&quot; &quot;cut^4&quot;</code></pre>
<p>You can also return the contrast method.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">get_contrast</span>(diamond_lm, <span class="dt">return_method =</span> T)</code></pre></div>
<pre><code>## $cut
## contr.poly</code></pre>
</div>
</div>
<div id="second-part-evaluate-marginal-effect" class="section level1">
<h1><span class="header-section-number">2</span> Second Part: Evaluate Marginal Effect</h1>
<p>In formula <code>y ~ a + I(a^2) + b</code>, We define ‘Marginal Effect’ of <code>a</code> on <code>y</code> as: fixing <code>b</code>, how the change of <code>a</code> will affect value of <code>y</code>. Note that the marginal effect here is not just the coefficients for <code>a</code> and <code>I(a^2)</code>, neither the sum.</p>
<div id="evaluate-marginal-effect-effect" class="section level3">
<h3><span class="header-section-number">2.0.1</span> evaluate marginal effect: <code>effect</code></h3>
<p>We provide a easy tool to show the marginal effect and check its monotonicity. The example below will evaluate how the <code>carat</code> of the diamond will affect its <code>price</code> in a particular model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># more carats, higher price.</span>
diamond_lm3 =<span class="st"> </span><span class="kw">lm</span>(price~<span class="st">  </span>carat +<span class="st"> </span><span class="kw">I</span>(carat^<span class="dv">2</span>) +<span class="st"> </span><span class="kw">I</span>(carat^<span class="dv">3</span>) , ggplot2::diamonds) <span class="co"># a GLM</span>

test1 =<span class="st"> </span><span class="kw">effect</span>(<span class="dt">model =</span> diamond_lm3, <span class="dt">focus_var_raw =</span> <span class="kw">c</span>(<span class="st">&#39;carat&#39;</span>), <span class="dt">focus_value =</span><span class="kw">list</span>(<span class="dt">carat =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="fl">0.1</span>))) </code></pre></div>
<p><img src="linear.tools_files/figure-html/unnamed-chunk-12-1.png" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test1$Monoton_Increase</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>You can see that the model did a good job to model monotonic increasing relations between <code>carat</code> and <code>price</code> when <code>carat</code> ranges from 0.5 to 1 (<code>$Monoton_Increase</code> is <code>True</code>).</p>
<p>PS: A more interesting case is that, if you interact <code>carat</code> with the categorical variable <code>cut</code>, you can examine the marginal effects <code>carat</code> under different categories of <code>cut</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test_interaction =<span class="st"> </span><span class="kw">effect</span>(<span class="dt">model =</span> <span class="kw">lm</span>(price~<span class="st">  </span>carat*cut +<span class="st"> </span><span class="kw">I</span>(carat^<span class="dv">2</span>)*cut, ggplot2::diamonds), 
       <span class="dt">focus_var_raw =</span> <span class="kw">c</span>(<span class="st">&#39;carat&#39;</span>,<span class="st">&#39;cut&#39;</span>), <span class="dt">focus_value =</span><span class="kw">list</span>(<span class="dt">carat =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="fl">0.1</span>))
       ) </code></pre></div>
<p><img src="linear.tools_files/figure-html/unnamed-chunk-13-1.png" /><!-- --></p>
<p>However, in the model <code>diamond_lm3</code> when we let the <code>carat</code> ranges from 0.5 to 6, the model failed to get the monotonic increasing relations: in the model below, when carat is larger than 3 approximately, the higher the carat, the lower the price!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test2 =<span class="st"> </span><span class="kw">effect</span>(<span class="dt">model =</span> diamond_lm3, <span class="dt">focus_var_raw =</span> <span class="kw">c</span>(<span class="st">&#39;carat&#39;</span>), <span class="dt">focus_value =</span><span class="kw">list</span>(<span class="dt">carat =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>,<span class="dv">6</span>,<span class="fl">0.1</span>))) </code></pre></div>
<p><img src="linear.tools_files/figure-html/unnamed-chunk-14-1.png" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test2$Monoton_Increase</code></pre></div>
<pre><code>## [1] FALSE</code></pre>
</div>
<div id="delete-the-marginal-effect-and-re-evaluate" class="section level3">
<h3><span class="header-section-number">2.0.2</span> delete the marginal effect and re-evaluate</h3>
<p>When a model has a wrong marginal effect, we can use function <code>deleting_wrongeffect</code> to delete a model variable that potentially causes the wrong marginal impacts and then re-estimate the model. This function can keep doing this until the correct marginal impacts are found.</p>
<p>The example below will</p>
<ul>
<li>first test the marginal effect of carat on price, which is supposed to be monotonic increasing.</li>
<li>then as it finds incorrect marginal effect, it will delete one model variable that contains <code>carat</code> in the most right, and then recheck the marginal effect.</li>
<li>It will keep doing the same thing until the marginal effect is correct, or all model variables containing <code>carat</code> are deleted.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model_correct_effect =<span class="st"> </span><span class="kw">deleting_wrongeffect</span>(<span class="dt">model =</span> diamond_lm3,
                                            <span class="dt">focus_var_raw =</span> <span class="st">&#39;carat&#39;</span>,
                                            <span class="dt">focus_value =</span> <span class="kw">list</span>(<span class="dt">carat=</span><span class="kw">seq</span>(<span class="fl">0.5</span>,<span class="dv">6</span>,<span class="fl">0.1</span>)),
                                            <span class="dt">data =</span> ggplot2::diamonds,
                                            <span class="dt">PRINT =</span> T,<span class="dt">STOP =</span>F, <span class="dt">PLOT =</span> T,
                                            <span class="dt">Reverse =</span> F)</code></pre></div>
<pre><code>## 
## initial model: 
##               Estimate     Pr(&gt;|t|)
## (Intercept)  -198.3337 3.930283e-11
## carat         812.3639 1.540245e-19
## I(carat^2)   5813.2637 0.000000e+00
## I(carat^3)  -1308.8438 0.000000e+00
## 
## 
## check raw var:  carat 
## check model var:  carat, I(carat^2), I(carat^3) 
## Correct Monotonicity is supposed to be:  Increasing</code></pre>
<p><img src="linear.tools_files/figure-html/unnamed-chunk-15-1.png" /><!-- --></p>
<pre><code>## Monotonicity is incorrect 
## Variable  I(carat^3)  shall be deleted, and the model shall be re-estimated. 
## -------------------------------------------------------
## 
## New Model: 
##               Estimate      Pr(&gt;|t|)
## (Intercept) -1832.5774  0.000000e+00
## carat        6677.0273  0.000000e+00
## I(carat^2)    507.9133 9.695712e-131
## 
## 
## check raw var:  carat 
## check model var:  carat, I(carat^2) 
## Correct Monotonicity is supposed to be:  Increasing</code></pre>
<p><img src="linear.tools_files/figure-html/unnamed-chunk-15-2.png" /><!-- --></p>
<pre><code>## Monotonicity is correct</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model_correct_effect</code></pre></div>
<pre><code>## 
## Call:  glm(formula = Formula_new, family = family, data = data0)
## 
## Coefficients:
## (Intercept)        carat   I(carat^2)  
##     -1832.6       6677.0        507.9  
## 
## Degrees of Freedom: 53939 Total (i.e. Null);  53937 Residual
## Null Deviance:       8.585e+11 
## Residual Deviance: 1.279e+11     AIC: 944900</code></pre>
</div>
<div id="stepwise-regression-with-correct-marginal-effect" class="section level3">
<h3><span class="header-section-number">2.0.3</span> stepwise regression with correct marginal effect</h3>
<p>Stepwise regression is popular in variable selection, but it failed to consider the correctness of marginal effects. <code>stepwise2</code> enables checking the marginal effects during each step of iteration in stepwise regression; so in each step we will skip those models with wrong marginal effects, and only only choose models among those that have correct marginal effect.</p>
<p>The example below is to use stepwise regression to find the model with highest BIC and with the correct marginal effect.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">scope =<span class="st"> </span><span class="kw">list</span>(<span class="dt">lower =</span> price ~<span class="st"> </span><span class="dv">1</span>,
             <span class="dt">upper =</span> price ~<span class="st">  </span>carat +<span class="st"> </span><span class="kw">I</span>(carat^<span class="dv">2</span>) +<span class="st"> </span><span class="kw">I</span>(carat^<span class="dv">3</span>) +<span class="st"> </span><span class="kw">I</span>(carat *<span class="st"> </span>depth) +<span class="st"> </span>depth)


### specify the correct marginal effect here
test_suit =<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">carat =</span> <span class="kw">list</span>( <span class="co"># the list name must be the raw var</span>
    <span class="dt">focus_var_raw =</span> <span class="st">&quot;carat&quot;</span>, <span class="co"># must specify the focus_var_raw (see deleting_wrongeffect() ) as the raw var</span>
    <span class="dt">focus_value =</span> <span class="kw">list</span>(<span class="dt">carat=</span><span class="kw">seq</span>(<span class="fl">0.5</span>,<span class="dv">6</span>,<span class="fl">0.1</span>))
  )
)

model_correct_effect =<span class="st">  </span><span class="kw">stepwise2</span>(<span class="dt">model =</span> diamond_lm3, <span class="dt">scope =</span> scope, <span class="dt">trace =</span> T,
                                  <span class="dt">data =</span> ggplot2::diamonds, <span class="dt">STOP =</span> F, <span class="dt">test_suit =</span> test_suit)</code></pre></div>
<pre><code>## 
##  price ~ carat+I(carat^2)+I(carat^3) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat^3) + I(carat*depth) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat^3) + depth 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat^3) - carat 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat^3) - I(carat^2) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat^3) - I(carat^3) 
## ------------------------
##                        IC nvar step_count correct_effect_ind
## + I(carat*depth) 938807.6    4          1                  0
## + depth          939091.3    4          1                  0
## origin           939528.7    3          1                  0
## - carat          939608.4    2          1                  0
## - I(carat^3)     944876.6    2          1                  1
## - I(carat^2)     945450.7    2          1                  1
## 
## 
## 
##  price ~ carat+I(carat^2) 
## ------------------------
##  price ~ carat+I(carat^2) + I(carat^3) 
## ------------------------
##  price ~ carat+I(carat^2) + I(carat*depth) 
## ------------------------
##  price ~ carat+I(carat^2) + depth 
## ------------------------
##  price ~ carat+I(carat^2) - carat 
## ------------------------
##  price ~ carat+I(carat^2) - I(carat^2) 
## ------------------------
##                        IC nvar step_count correct_effect_ind
## + I(carat^3)     939528.7    3          2                  0
## + I(carat*depth) 943888.0    3          2                  1
## + depth          944394.5    3          2                  1
## origin           944876.6    2          2                  1
## - I(carat^2)     945466.5    1          2                  1
## - carat          962398.3    1          2                  1
## 
## 
## 
##  price ~ carat+I(carat^2)+I(carat*depth) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth) + I(carat^3) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth) + depth 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth) - carat 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth) - I(carat^2) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth) - I(carat*depth) 
## ------------------------
##                        IC nvar step_count correct_effect_ind
## + I(carat^3)     938807.6    4          3                  0
## + depth          943753.7    4          3                  1
## origin           943888.0    3          3                  1
## - I(carat^2)     944552.6    2          3                  1
## - I(carat*depth) 944876.6    2          3                  1
## - carat          946883.6    2          3                  1
## 
## 
## 
##  price ~ carat+I(carat^2)+I(carat*depth)+depth 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth)+depth + I(carat^3) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth)+depth - carat 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth)+depth - I(carat^2) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth)+depth - I(carat*depth) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth)+depth - depth 
## ------------------------
##                        IC nvar step_count correct_effect_ind
## + I(carat^3)     938779.0    5          4                  0
## origin           943753.7    4          4                  1
## - depth          943888.0    3          4                  1
## - I(carat*depth) 944394.5    3          4                  1
## - I(carat^2)     944466.4    3          4                  1
## - carat          945118.7    3          4                  1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># the returned model</span>
model_correct_effect</code></pre></div>
<pre><code>## 
## Call:  glm(formula = price ~ carat + I(carat^2) + I(carat * depth) + 
##     depth, family = family, data = data)
## 
## Coefficients:
##      (Intercept)             carat        I(carat^2)  I(carat * depth)  
##          -8695.2           20984.0             555.1            -233.1  
##            depth  
##            111.7  
## 
## Degrees of Freedom: 53939 Total (i.e. Null);  53935 Residual
## Null Deviance:       8.585e+11 
## Residual Deviance: 1.253e+11     AIC: 943800</code></pre>
</div>
<div id="compare-with-step" class="section level3">
<h3><span class="header-section-number">2.0.4</span> compare with <code>step</code></h3>
<p>The model using <code>stepwise2</code> got correct marginal effect:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test_model_correct_effect =<span class="st"> </span><span class="kw">effect</span>(<span class="dt">model =</span> model_correct_effect, <span class="dt">focus_var_raw =</span> <span class="kw">c</span>(<span class="st">&#39;carat&#39;</span>), <span class="dt">focus_value =</span><span class="kw">list</span>(<span class="dt">carat =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>,<span class="dv">6</span>,<span class="fl">0.1</span>))) </code></pre></div>
<p><img src="linear.tools_files/figure-html/unnamed-chunk-17-1.png" /><!-- --></p>
<p>whereas the model using traditional algorithm <code>step</code> got wrong marginal effect:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model_wrong_effect =<span class="st">  </span><span class="kw">step</span>(diamond_lm3, <span class="dt">scope =</span> scope, <span class="dt">trace =</span> F, <span class="dt">data =</span> ggplot2::diamonds)
model_wrong_effect</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = price ~ carat + I(carat^2) + I(carat^3) + I(carat * 
##     depth) + depth, data = ggplot2::diamonds)
## 
## Coefficients:
##      (Intercept)             carat        I(carat^2)        I(carat^3)  
##         -3373.61          10638.46           5650.71          -1261.05  
## I(carat * depth)             depth  
##          -156.54             50.77</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test_wrong_effect =<span class="st"> </span><span class="kw">effect</span>(model_wrong_effect, <span class="dt">focus_var_raw =</span> <span class="kw">c</span>(<span class="st">&#39;carat&#39;</span>), <span class="dt">focus_value =</span><span class="kw">list</span>(<span class="dt">carat =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>,<span class="dv">6</span>,<span class="fl">0.1</span>))) </code></pre></div>
<p><img src="linear.tools_files/figure-html/unnamed-chunk-18-1.png" /><!-- --></p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
