<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Linear.tools GitHub by Fan-Yang-Econ</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Linear.tools GitHub</h1>
        <h2>See CRAN for the official version</h2>
        <a href="https://github.com/Fan-Yang-Econ/linear.tools_github" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>
<a id="--lineartools-------" class="anchor" href="#--lineartools-------" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a> <h1>
<a id="-lineartools-" class="anchor" href="#-lineartools-" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a> linear.tools </h1>   <h1>
<a id="--" class="anchor" href="#--" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>  </h1> </h1>

<p> Fan Yang <br>
2015-08-10 </p> <h1>
<a id="---1" class="anchor" href="#---1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>  </h1>   

<p></p> <h1>
<a id="---2" class="anchor" href="#---2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>  </h1>  

<p>Abstract:</p>

<p>This packages enables "marginal effect regularization" in stepwise algorithm.</p>

<p>Traditional machine learning algorithms only try to achieve lowest loss or max likelihood, they did not bring economic theory or business justification into the iteration process of searching the best model. </p>

<p>That means, a feature with wrong marginal impact on the dependent may be selected solely based on statistical soundness, despite that is contradictory to economic theory.</p>

<p>This package enables specifying and checking the correctness of marginal effect during the iteration of stepwise algorithm. Thus you can put the direction of marginal effect justified by pre-defined economic theory as constraint in the process of searching best model.</p>

<p></p> <h1>
<a id="---3" class="anchor" href="#---3" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>  </h1>  

<p>This package has two parts: </p>

<ul>
<li>The first part provides tools to manipulate formulas.</li>
<li>The second part provides functions to evaluate and check the marginal impacts of a linear model.</li>
</ul>

<h1>
<a id="first-part-manipulate-formulas" class="anchor" href="#first-part-manipulate-formulas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>First Part: Manipulate formulas</h1>

<h3>
<a id="different-forms-of-x" class="anchor" href="#different-forms-of-x" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>different forms of x</h3>

<p>Variables in R's linear formula/model can have different forms:</p>

<ol>
<li> Model variables, the items showed up directly in the formula, separated by the '+' sign.</li>
<li> Raw variables, the underlying variables used.</li>
<li> Coefficient variables, the coefficient names; note that un-evaluated formulas don't have those variables.</li>
</ol>

<h3>
<a id="model-variables-get_xformulamodelcoeff" class="anchor" href="#model-variables-get_xformulamodelcoeff" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>model variables: <code>get_x(formula/model,'coeff')</code>
</h3>

<div class="highlight highlight-source-r"><pre><span class="pl-v">data</span> <span class="pl-k">=</span> <span class="pl-e">ggplot2</span><span class="pl-k">::</span><span class="pl-smi">diamonds</span>
<span class="pl-v">diamond_lm</span>  <span class="pl-k">=</span>  lm(log(<span class="pl-smi">price</span>)<span class="pl-k">~</span>  I(<span class="pl-smi">carat</span><span class="pl-k">^</span>   <span class="pl-c1">2</span>) <span class="pl-k">+</span> <span class="pl-smi">cut</span>  <span class="pl-k">+</span> <span class="pl-smi">carat</span> <span class="pl-k">+</span> <span class="pl-smi">table</span> <span class="pl-k">+</span> <span class="pl-smi">carat</span><span class="pl-k">:</span><span class="pl-smi">table</span>, <span class="pl-smi">data</span>)</pre></div>

<p>At the first sight, the linear model above contains 5  variables:</p>

<ul>
<li>I(carat^   2)</li>
<li>cut</li>
<li>carat</li>
<li>table</li>
<li>carat:table</li>
</ul>

<p>In linear.tools we call them <em>model</em> variables and can access them using function <code>get_x(.,'model')</code>:</p>

<div class="highlight highlight-source-r"><pre>get_x(<span class="pl-smi">diamond_lm</span>,<span class="pl-s"><span class="pl-pds">'</span>model<span class="pl-pds">'</span></span>)</pre></div>

<pre><code>## [1] "I(carat^2)"  "cut"         "carat"       "table"       "carat:table"
</code></pre>

<p>Note that in the original formula, there are redundant spaces 'I(carat^   2)'; in <code>get_x(.,'model')</code> we deleted them.</p>

<h3>
<a id="raw-variables-get_xformulamodelcoeff" class="anchor" href="#raw-variables-get_xformulamodelcoeff" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>raw variables: <code>get_x(formula/model,'coeff')</code>
</h3>

<p>Sometimes you want to get the underlying raw variables used in the formula, which are</p>

<ul>
<li>carat (the underlying variable for I(carat^   2))</li>
<li>cut</li>
<li>carat</li>
<li>table</li>
</ul>

<p>In linear.tools we call them <em>raw</em> variables and can access them using function <code>get_x(.,'raw')</code>:</p>

<div class="highlight highlight-source-r"><pre>get_x(<span class="pl-smi">diamond_lm</span>,<span class="pl-s"><span class="pl-pds">'</span>raw<span class="pl-pds">'</span></span>)</pre></div>

<pre><code>## [1] "carat" "cut"   "table"
</code></pre>

<p><code>get_x(.,'model')</code> will show the linkage between model variables and raw variables: it will return a list with names as model variables and elements as their corresponding raw variables.</p>

<div class="highlight highlight-source-r"><pre>get_model_pair(<span class="pl-smi">diamond_lm</span>, <span class="pl-smi">data</span>, <span class="pl-s"><span class="pl-pds">'</span>raw<span class="pl-pds">'</span></span>)</pre></div>

<pre><code>## $`I(carat^2)`
## [1] "carat"
## 
## $cut
## [1] "cut"
## 
## $carat
## [1] "carat"
## 
## $table
## [1] "table"
## 
## $`carat:table`
## [1] "carat" "table"
</code></pre>

<h3>
<a id="coefficient-variables-get_xmodelcoeff" class="anchor" href="#coefficient-variables-get_xmodelcoeff" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>coefficient variables: <code>get_x(model,'coeff')</code>
</h3>

<p>Sometimes you want the the coefficient names of the model</p>

<div class="highlight highlight-source-r"><pre>get_x(<span class="pl-smi">diamond_lm</span>,<span class="pl-s"><span class="pl-pds">'</span>coeff<span class="pl-pds">'</span></span>)</pre></div>

<pre><code>## [1] "I(carat^2)"  "cut.L"       "cut.Q"       "cut.C"       "cut^4"      
## [6] "carat"       "table"       "carat:table"
</code></pre>

<p>You may also want to see how 'model' variables are linked with 'coeff' variables: <code>get_x(.,'coeff')</code> will return a list with names as model variables and elements as their corresponding coeff variables.</p>

<div class="highlight highlight-source-r"><pre>get_model_pair(<span class="pl-smi">diamond_lm</span>, <span class="pl-smi">data</span>, <span class="pl-s"><span class="pl-pds">'</span>coeff<span class="pl-pds">'</span></span>)</pre></div>

<pre><code>## $`I(carat^2)`
## [1] "I(carat^2)"
## 
## $cut
## [1] "cut.L" "cut.Q" "cut.C" "cut^4"
## 
## $carat
## [1] "carat"
## 
## $table
## [1] "table"
## 
## $`carat:table`
## [1] "carat:table"
</code></pre>

<h3>
<a id="link-different-forms-of-x-get_x_allmodel" class="anchor" href="#link-different-forms-of-x-get_x_allmodel" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>link different forms of x: <code>get_x_all(model)</code>
</h3>

<p>The <code>get_x_all()</code> function will return a data.frame showing all the model variables and their corresponding raw &amp; coefficient variables.</p>

<div class="highlight highlight-source-r"><pre>get_x_all(<span class="pl-v">model</span> <span class="pl-k">=</span> <span class="pl-smi">diamond_lm</span>)</pre></div>

<pre><code>##     raw       model       coeff n_raw_in_model
## 1 carat  I(carat^2)  I(carat^2)              1
## 2   cut         cut       cut.L              1
## 3   cut         cut       cut.Q              1
## 4   cut         cut       cut.C              1
## 5   cut         cut       cut^4              1
## 6 carat       carat       carat              1
## 7 table       table       table              1
## 8 carat carat:table carat:table              2
## 9 table carat:table carat:table              2
</code></pre>

<h3>
<a id="get-y--get_yformulamodel" class="anchor" href="#get-y--get_yformulamodel" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>get y : <code>get_y(formula/model)</code>
</h3>

<div class="highlight highlight-source-r"><pre>get_y(<span class="pl-smi">diamond_lm</span>,<span class="pl-s"><span class="pl-pds">'</span>raw<span class="pl-pds">'</span></span>)</pre></div>

<pre><code>## [1] "price"
</code></pre>

<div class="highlight highlight-source-r"><pre>get_y(<span class="pl-smi">diamond_lm</span>,<span class="pl-s"><span class="pl-pds">'</span>model<span class="pl-pds">'</span></span>)</pre></div>

<pre><code>## [1] "log(price)"
</code></pre>

<h2>
<a id="contrast-get_contrastmodel" class="anchor" href="#contrast-get_contrastmodel" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>contrast: get_contrast(model)</h2>

<p>Contrasts are how categorical variables show up in coefficients.</p>

<p>When R evaluate categorical variables in the linear model, R will transform them into sets of 'contrasts' using certain contrast encoding schedule. See <a href="http://www.ats.ucla.edu/stat/r/library/contrast_coding.htm">UCLA idre</a> for details.</p>

<p>For example, for categorical variable 'cut' in the above model, we can get its contrasts through function <code>get_contrast</code></p>

<div class="highlight highlight-source-r"><pre><span class="pl-c"># get_contrast will return a list with each element as the contrasts of a categorical variable in the model</span>
get_contrast(<span class="pl-smi">diamond_lm</span>)</pre></div>

<pre><code>## $cut
## [1] "cut.L" "cut.Q" "cut.C" "cut^4"
</code></pre>

<p>You can also return the contrast method.</p>

<div class="highlight highlight-source-r"><pre>get_contrast(<span class="pl-smi">diamond_lm</span>, <span class="pl-v">return_method</span> <span class="pl-k">=</span> <span class="pl-c1">T</span>)</pre></div>

<pre><code>## $cut
## contr.poly
</code></pre>

<h1>
<a id="second-part-evaluate-marginal-effect" class="anchor" href="#second-part-evaluate-marginal-effect" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Second Part: Evaluate Marginal Effect</h1>

<p>In formula <code>y ~ a + I(a^2) + b</code>, We define 'Marginal Effect' of <code>a</code> on <code>y</code> as: fixing <code>b</code>, how the change of <code>a</code> will affect value of <code>y</code>. Note that the marginal effect here is not just the coefficients for <code>a</code> and <code>I(a^2)</code>, neither the sum.</p>

<h3>
<a id="evaluate-marginal-effect-effect" class="anchor" href="#evaluate-marginal-effect-effect" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>evaluate marginal effect: <code>effect</code>
</h3>

<p>We provide a easy tool to show the marginal effect and check its monotonicity. The example below will evaluate how the <code>carat</code> of the diamond will affect its <code>price</code> in a particular model.</p>

<div class="highlight highlight-source-r"><pre><span class="pl-c"># more carats, higher price.</span>
<span class="pl-v">diamond_lm3</span> <span class="pl-k">=</span> lm(<span class="pl-smi">price</span><span class="pl-k">~</span>  <span class="pl-smi">carat</span> <span class="pl-k">+</span> I(<span class="pl-smi">carat</span><span class="pl-k">^</span><span class="pl-c1">2</span>) <span class="pl-k">+</span> I(<span class="pl-smi">carat</span><span class="pl-k">^</span><span class="pl-c1">3</span>) , <span class="pl-e">ggplot2</span><span class="pl-k">::</span><span class="pl-smi">diamonds</span>) <span class="pl-c"># a GLM</span>

<span class="pl-v">test1</span> <span class="pl-k">=</span> effect(<span class="pl-v">model</span> <span class="pl-k">=</span> <span class="pl-smi">diamond_lm3</span>, <span class="pl-v">focus_var_raw</span> <span class="pl-k">=</span> c(<span class="pl-s"><span class="pl-pds">'</span>carat<span class="pl-pds">'</span></span>), <span class="pl-v">focus_value</span> <span class="pl-k">=</span><span class="pl-k">list</span>(<span class="pl-v">carat</span> <span class="pl-k">=</span> seq(<span class="pl-c1">0.5</span>,<span class="pl-c1">1</span>,<span class="pl-c1">0.1</span>))) </pre></div>

<p><img src="https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-12-1.png" alt=""></p>

<div class="highlight highlight-source-r"><pre><span class="pl-smi">test1</span><span class="pl-k">$</span><span class="pl-smi">Monoton_Increase</span></pre></div>

<pre><code>## [1] TRUE
</code></pre>

<p>You can see that the model did a good job to model monotonic increasing relations between <code>carat</code> and <code>price</code> when <code>carat</code> ranges from 0.5 to 1 (<code>$Monoton_Increase</code> is <code>True</code>).</p>

<p>PS: A more interesting case is that, if you interact <code>carat</code> with the categorical variable <code>cut</code>, you can examine the marginal effects <code>carat</code> under different categories of <code>cut</code></p>

<div class="highlight highlight-source-r"><pre><span class="pl-v">test_interaction</span> <span class="pl-k">=</span> effect(<span class="pl-v">model</span> <span class="pl-k">=</span> lm(<span class="pl-smi">price</span><span class="pl-k">~</span>  <span class="pl-smi">carat</span><span class="pl-k">*</span><span class="pl-smi">cut</span> <span class="pl-k">+</span> I(<span class="pl-smi">carat</span><span class="pl-k">^</span><span class="pl-c1">2</span>)<span class="pl-k">*</span><span class="pl-smi">cut</span>, <span class="pl-e">ggplot2</span><span class="pl-k">::</span><span class="pl-smi">diamonds</span>), 
       <span class="pl-v">focus_var_raw</span> <span class="pl-k">=</span> c(<span class="pl-s"><span class="pl-pds">'</span>carat<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>cut<span class="pl-pds">'</span></span>), <span class="pl-v">focus_value</span> <span class="pl-k">=</span><span class="pl-k">list</span>(<span class="pl-v">carat</span> <span class="pl-k">=</span> seq(<span class="pl-c1">0.5</span>,<span class="pl-c1">1</span>,<span class="pl-c1">0.1</span>))
       ) </pre></div>

<p><img src="https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-13-1.png" alt=""></p>

<p>However, in the model <code>diamond_lm3</code> when we let the <code>carat</code> ranges from 0.5 to 6, the model failed to get the monotonic increasing relations: in the model below, when carat is larger than 3 approximately, the higher the carat, the lower the price!</p>

<div class="highlight highlight-source-r"><pre><span class="pl-v">test2</span> <span class="pl-k">=</span> effect(<span class="pl-v">model</span> <span class="pl-k">=</span> <span class="pl-smi">diamond_lm3</span>, <span class="pl-v">focus_var_raw</span> <span class="pl-k">=</span> c(<span class="pl-s"><span class="pl-pds">'</span>carat<span class="pl-pds">'</span></span>), <span class="pl-v">focus_value</span> <span class="pl-k">=</span><span class="pl-k">list</span>(<span class="pl-v">carat</span> <span class="pl-k">=</span> seq(<span class="pl-c1">0.5</span>,<span class="pl-c1">6</span>,<span class="pl-c1">0.1</span>))) </pre></div>

<p><img src="https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-14-1.png" alt=""></p>

<div class="highlight highlight-source-r"><pre><span class="pl-smi">test2</span><span class="pl-k">$</span><span class="pl-smi">Monoton_Increase</span></pre></div>

<pre><code>## [1] FALSE
</code></pre>

<h3>
<a id="delete-the-marginal-effect-and-re-evaluate" class="anchor" href="#delete-the-marginal-effect-and-re-evaluate" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>delete the marginal effect and re-evaluate</h3>

<p>When a model has a wrong marginal effect, we can use function <code>deleting_wrongeffect</code> to delete a model variable that potentially causes the wrong marginal impacts and then re-estimate the model. This function can keep doing this until the correct marginal impacts are found.</p>

<p>The example below will</p>

<ul>
<li>first test the marginal effect of carat on price, which is supposed to be monotonic increasing.</li>
<li>then as it finds incorrect marginal effect, it will delete one model variable that contains <code>carat</code> in the most right, and then recheck the marginal effect.</li>
<li>It will keep doing the same thing until the marginal effect is correct, or all model variables containing <code>carat</code> are deleted.</li>
</ul>

<div class="highlight highlight-source-r"><pre><span class="pl-v">model_correct_effect</span> <span class="pl-k">=</span> deleting_wrongeffect(<span class="pl-v">model</span> <span class="pl-k">=</span> <span class="pl-smi">diamond_lm3</span>,
                                            <span class="pl-v">focus_var_raw</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>carat<span class="pl-pds">'</span></span>,
                                            <span class="pl-v">focus_value</span> <span class="pl-k">=</span> <span class="pl-k">list</span>(<span class="pl-v">carat</span><span class="pl-k">=</span>seq(<span class="pl-c1">0.5</span>,<span class="pl-c1">6</span>,<span class="pl-c1">0.1</span>)),
                                            <span class="pl-v">data</span> <span class="pl-k">=</span> <span class="pl-e">ggplot2</span><span class="pl-k">::</span><span class="pl-smi">diamonds</span>,
                                            <span class="pl-v">PRINT</span> <span class="pl-k">=</span> <span class="pl-c1">T</span>,<span class="pl-v">STOP</span> <span class="pl-k">=</span><span class="pl-c1">F</span>, <span class="pl-v">PLOT</span> <span class="pl-k">=</span> <span class="pl-c1">T</span>,
                                            <span class="pl-v">Reverse</span> <span class="pl-k">=</span> <span class="pl-c1">F</span>)</pre></div>

<pre><code>## 
## initial model: 
##               Estimate     Pr(&gt;|t|)
## (Intercept)  -198.3337 3.930283e-11
## carat         812.3639 1.540245e-19
## I(carat^2)   5813.2637 0.000000e+00
## I(carat^3)  -1308.8438 0.000000e+00
## 
## 
## check raw var:  carat 
## check model var:  carat, I(carat^2), I(carat^3) 
## Correct Monotonicity is supposed to be:  Increasing
</code></pre>

<p><img src="https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-15-1.png" alt=""></p>

<pre><code>## Monotonicity is incorrect 
## Variable  I(carat^3)  shall be deleted, and the model shall be re-estimated. 
## -------------------------------------------------------
## 
## New Model: 
##               Estimate      Pr(&gt;|t|)
## (Intercept) -1832.5774  0.000000e+00
## carat        6677.0273  0.000000e+00
## I(carat^2)    507.9133 9.695712e-131
## 
## 
## check raw var:  carat 
## check model var:  carat, I(carat^2) 
## Correct Monotonicity is supposed to be:  Increasing
</code></pre>

<p><img src="https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-15-2.png" alt=""></p>

<pre><code>## Monotonicity is correct
</code></pre>

<div class="highlight highlight-source-r"><pre><span class="pl-smi">model_correct_effect</span></pre></div>

<pre><code>## 
## Call:  glm(formula = Formula_new, family = family, data = data0)
## 
## Coefficients:
## (Intercept)        carat   I(carat^2)  
##     -1832.6       6677.0        507.9  
## 
## Degrees of Freedom: 53939 Total (i.e. Null);  53937 Residual
## Null Deviance:       8.585e+11 
## Residual Deviance: 1.279e+11     AIC: 944900
</code></pre>

<h3>
<a id="stepwise-regression-with-correct-marginal-effect" class="anchor" href="#stepwise-regression-with-correct-marginal-effect" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>stepwise regression with correct marginal effect</h3>

<p>Stepwise regression is popular in variable selection, but it failed to consider the correctness of marginal effects. <code>stepwise2</code> enables checking the marginal effects during each step of iteration in stepwise regression; so in each step we will skip those models with wrong marginal effects, and only only choose models among those that have correct marginal effect.</p>

<p>The example below is to use stepwise regression to find the model with highest BIC and with the correct marginal effect.</p>

<div class="highlight highlight-source-r"><pre><span class="pl-v">scope</span> <span class="pl-k">=</span> <span class="pl-k">list</span>(<span class="pl-v">lower</span> <span class="pl-k">=</span> <span class="pl-smi">price</span> <span class="pl-k">~</span> <span class="pl-c1">1</span>,
             <span class="pl-v">upper</span> <span class="pl-k">=</span> <span class="pl-smi">price</span> <span class="pl-k">~</span>  <span class="pl-smi">carat</span> <span class="pl-k">+</span> I(<span class="pl-smi">carat</span><span class="pl-k">^</span><span class="pl-c1">2</span>) <span class="pl-k">+</span> I(<span class="pl-smi">carat</span><span class="pl-k">^</span><span class="pl-c1">3</span>) <span class="pl-k">+</span> I(<span class="pl-smi">carat</span> <span class="pl-k">*</span> <span class="pl-smi">depth</span>) <span class="pl-k">+</span> <span class="pl-smi">depth</span>)


<span class="pl-c">### specify the correct marginal effect here</span>
<span class="pl-v">test_suit</span> <span class="pl-k">=</span> <span class="pl-k">list</span>(
  <span class="pl-v">carat</span> <span class="pl-k">=</span> <span class="pl-k">list</span>( <span class="pl-c"># the list name must be the raw var</span>
    <span class="pl-v">focus_var_raw</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>carat<span class="pl-pds">"</span></span>, <span class="pl-c"># must specify the focus_var_raw (see deleting_wrongeffect() ) as the raw var</span>
    <span class="pl-v">focus_value</span> <span class="pl-k">=</span> <span class="pl-k">list</span>(<span class="pl-v">carat</span><span class="pl-k">=</span>seq(<span class="pl-c1">0.5</span>,<span class="pl-c1">6</span>,<span class="pl-c1">0.1</span>))
  )
)

<span class="pl-v">model_correct_effect</span> <span class="pl-k">=</span>  stepwise2(<span class="pl-v">model</span> <span class="pl-k">=</span> <span class="pl-smi">diamond_lm3</span>, <span class="pl-v">scope</span> <span class="pl-k">=</span> <span class="pl-smi">scope</span>, <span class="pl-v">trace</span> <span class="pl-k">=</span> <span class="pl-c1">T</span>,
                                  <span class="pl-v">data</span> <span class="pl-k">=</span> <span class="pl-e">ggplot2</span><span class="pl-k">::</span><span class="pl-smi">diamonds</span>, <span class="pl-v">STOP</span> <span class="pl-k">=</span> <span class="pl-c1">F</span>, <span class="pl-v">test_suit</span> <span class="pl-k">=</span> <span class="pl-smi">test_suit</span>)</pre></div>

<pre><code>## 
##  price ~ carat+I(carat^2)+I(carat^3) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat^3) + I(carat*depth) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat^3) + depth 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat^3) - carat 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat^3) - I(carat^2) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat^3) - I(carat^3) 
## ------------------------
##                        IC nvar step_count correct_effect_ind
## + I(carat*depth) 938807.6    4          1                  0
## + depth          939091.3    4          1                  0
## origin           939528.7    3          1                  0
## - carat          939608.4    2          1                  0
## - I(carat^3)     944876.6    2          1                  1
## - I(carat^2)     945450.7    2          1                  1
## 
## 
## 
##  price ~ carat+I(carat^2) 
## ------------------------
##  price ~ carat+I(carat^2) + I(carat^3) 
## ------------------------
##  price ~ carat+I(carat^2) + I(carat*depth) 
## ------------------------
##  price ~ carat+I(carat^2) + depth 
## ------------------------
##  price ~ carat+I(carat^2) - carat 
## ------------------------
##  price ~ carat+I(carat^2) - I(carat^2) 
## ------------------------
##                        IC nvar step_count correct_effect_ind
## + I(carat^3)     939528.7    3          2                  0
## + I(carat*depth) 943888.0    3          2                  1
## + depth          944394.5    3          2                  1
## origin           944876.6    2          2                  1
## - I(carat^2)     945466.5    1          2                  1
## - carat          962398.3    1          2                  1
## 
## 
## 
##  price ~ carat+I(carat^2)+I(carat*depth) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth) + I(carat^3) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth) + depth 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth) - carat 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth) - I(carat^2) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth) - I(carat*depth) 
## ------------------------
##                        IC nvar step_count correct_effect_ind
## + I(carat^3)     938807.6    4          3                  0
## + depth          943753.7    4          3                  1
## origin           943888.0    3          3                  1
## - I(carat^2)     944552.6    2          3                  1
## - I(carat*depth) 944876.6    2          3                  1
## - carat          946883.6    2          3                  1
## 
## 
## 
##  price ~ carat+I(carat^2)+I(carat*depth)+depth 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth)+depth + I(carat^3) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth)+depth - carat 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth)+depth - I(carat^2) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth)+depth - I(carat*depth) 
## ------------------------
##  price ~ carat+I(carat^2)+I(carat*depth)+depth - depth 
## ------------------------
##                        IC nvar step_count correct_effect_ind
## + I(carat^3)     938779.0    5          4                  0
## origin           943753.7    4          4                  1
## - depth          943888.0    3          4                  1
## - I(carat*depth) 944394.5    3          4                  1
## - I(carat^2)     944466.4    3          4                  1
## - carat          945118.7    3          4                  1
</code></pre>

<div class="highlight highlight-source-r"><pre><span class="pl-c"># the returned model</span>
<span class="pl-smi">model_correct_effect</span></pre></div>

<pre><code>## 
## Call:  glm(formula = price ~ carat + I(carat^2) + I(carat * depth) + 
##     depth, family = family, data = data)
## 
## Coefficients:
##      (Intercept)             carat        I(carat^2)  I(carat * depth)  
##          -8695.2           20984.0             555.1            -233.1  
##            depth  
##            111.7  
## 
## Degrees of Freedom: 53939 Total (i.e. Null);  53935 Residual
## Null Deviance:       8.585e+11 
## Residual Deviance: 1.253e+11     AIC: 943800
</code></pre>

<h3>
<a id="compare-with-step" class="anchor" href="#compare-with-step" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>compare with <code>step</code>
</h3>

<p>The model using <code>stepwise2</code> got correct marginal effect:</p>

<div class="highlight highlight-source-r"><pre><span class="pl-v">test_model_correct_effect</span> <span class="pl-k">=</span> effect(<span class="pl-v">model</span> <span class="pl-k">=</span> <span class="pl-smi">model_correct_effect</span>, <span class="pl-v">focus_var_raw</span> <span class="pl-k">=</span> c(<span class="pl-s"><span class="pl-pds">'</span>carat<span class="pl-pds">'</span></span>), <span class="pl-v">focus_value</span> <span class="pl-k">=</span><span class="pl-k">list</span>(<span class="pl-v">carat</span> <span class="pl-k">=</span> seq(<span class="pl-c1">0.5</span>,<span class="pl-c1">6</span>,<span class="pl-c1">0.1</span>))) </pre></div>

<p><img src="https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-17-1.png" alt=""></p>

<p>whereas the model using traditional algorithm <code>step</code> got wrong marginal effect:</p>

<div class="highlight highlight-source-r"><pre><span class="pl-v">model_wrong_effect</span> <span class="pl-k">=</span>  step(<span class="pl-smi">diamond_lm3</span>, <span class="pl-v">scope</span> <span class="pl-k">=</span> <span class="pl-smi">scope</span>, <span class="pl-v">trace</span> <span class="pl-k">=</span> <span class="pl-c1">F</span>, <span class="pl-v">data</span> <span class="pl-k">=</span> <span class="pl-e">ggplot2</span><span class="pl-k">::</span><span class="pl-smi">diamonds</span>)
<span class="pl-smi">model_wrong_effect</span></pre></div>

<pre><code>## 
## Call:
## lm(formula = price ~ carat + I(carat^2) + I(carat^3) + I(carat * 
##     depth) + depth, data = ggplot2::diamonds)
## 
## Coefficients:
##      (Intercept)             carat        I(carat^2)        I(carat^3)  
##         -3373.61          10638.46           5650.71          -1261.05  
## I(carat * depth)             depth  
##          -156.54             50.77
</code></pre>

<div class="highlight highlight-source-r"><pre><span class="pl-v">test_wrong_effect</span> <span class="pl-k">=</span> effect(<span class="pl-smi">model_wrong_effect</span>, <span class="pl-v">focus_var_raw</span> <span class="pl-k">=</span> c(<span class="pl-s"><span class="pl-pds">'</span>carat<span class="pl-pds">'</span></span>), <span class="pl-v">focus_value</span> <span class="pl-k">=</span><span class="pl-k">list</span>(<span class="pl-v">carat</span> <span class="pl-k">=</span> seq(<span class="pl-c1">0.5</span>,<span class="pl-c1">6</span>,<span class="pl-c1">0.1</span>))) </pre></div>

<p><img src="https://raw.githubusercontent.com/Fan-Yang-Econ/linear.tools_github/master/linear.tools_files/figure-html/unnamed-chunk-18-1.png" alt=""></p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/Fan-Yang-Econ/linear.tools_github/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/Fan-Yang-Econ/linear.tools_github/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/Fan-Yang-Econ/linear.tools_github"></a> is maintained by <a href="https://github.com/Fan-Yang-Econ">Fan-Yang-Econ</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>
